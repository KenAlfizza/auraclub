datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum RoleType {
  regular
  cashier
  manager
  superuser
}

enum TransactionType {
  purchase
  redemption
  adjustment
  event
  transfer
}

enum PromotionType {
  automatic
  onetime
}

model User {
  id          Int            @id @default(autoincrement())
  name        String 
  password    String?
  email       String         @unique
  utorid      String         @unique
  birthday    DateTime?
  verified    Boolean        @default(false)
  avatarUrl   String?                  
  
  role        RoleType       @default(regular)
  suspicious  Boolean        @default(false)

  points      Int            @default(0)

  loginToken  LoginToken?
  resetToken  ResetToken?

  transactions        Transaction[] @relation("UserTransactions")
  createdTransactions Transaction[] @relation("UserCreatedTransactions")

  promotions  Promotion[]

  createdAt   DateTime       @default(now())
  lastLogin   DateTime?

}

model LoginToken {
  id        Int         @id @default(autoincrement())
  token     String
  createdAt DateTime    @default(now())
  expiresAt DateTime

  userId    Int         @unique
  user      User        @relation(fields: [userId], references:[id])
}

model ResetToken {
  id        Int         @id @default(autoincrement())
  token     String
  createdAt DateTime    @default(now())
  expiresAt DateTime
  used      Boolean     @default(false)

  userId    Int         @unique
  user      User        @relation(fields: [userId], references:[id])
}

model Transaction {
  id            Int               @id @default(autoincrement())
  type          TransactionType
  amount        Int?
  spent         Float? 

  suspicious    Boolean           @default(false)
  remark        String?
 

  userId        Int
  createdById   Int

  user          User              @relation("UserTransactions", fields: [userId], references: [id])
  createdBy     User              @relation("UserCreatedTransactions", fields: [createdById], references: [id])
  
  createdAt     DateTime          @default(now())
}

model Promotion {
  id            Int           @id @default(autoincrement())
  name          String
  description   String
  type          PromotionType
  startTime     DateTime
  endTime       DateTime
  minSpending   Float?
  rate          Float?
  points        Int?

  usedBy        User[]
}