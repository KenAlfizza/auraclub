datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum RoleType {
  regular
  cashier
  manager
  superuser
}

enum TransactionType {
  purchase
  redemption
  adjustment
  event
  transfer
}

enum PromotionType {
  automatic
  onetime
}

model User {
  id          Int            @id @default(autoincrement())
  name        String 
  password    String?
  email       String         @unique
  utorid      String         @unique
  birthday    DateTime?
  verified    Boolean        @default(false)
  avatarUrl   String?                  
  
  role        RoleType       @default(regular)
  suspicious  Boolean        @default(false)

  points      Int            @default(0)

  loginToken  LoginToken?
  resetToken  ResetToken?

  transactionsUser            Transaction[] @relation("UserTransactions")           // Transactions associated with the user (recipient/subject)
  transactionsCreator         Transaction[] @relation("UserCreatedTransactions")    // Transactions created by this user (e.g., cashier/regular user)
  transactionsProcessor       Transaction[] @relation("UserProcessedTransactions")  // Transactions processed by this user (e.g., cashier processing redemption)

  // Tracks which one-time promotions the user has used. This is necessary for dynamic filtering of "available" promotions
  promotionsUsed Promotion[]  @relation("UserPromotionsUsed")

  createdAt   DateTime       @default(now())
  lastLogin   DateTime?

}

model LoginToken {
  id        Int         @id @default(autoincrement())
  token     String
  createdAt DateTime    @default(now())
  expiresAt DateTime

  userId    Int         @unique
  user      User        @relation(fields: [userId], references:[id])
}

model ResetToken {
  id        Int         @id @default(autoincrement())
  token     String
  createdAt DateTime    @default(now())
  expiresAt DateTime
  used      Boolean     @default(false)

  userId    Int         @unique
  user      User        @relation(fields: [userId], references:[id])
}

model Transaction {
  id            Int               @id @default(autoincrement())
  type          TransactionType
  amount        Int?
  spent         Float? 
  redeemed      Int?

  promotions    Promotion[]  

  suspicious    Boolean           @default(false)
  remark        String?

  userId        Int
  createdById   Int
  processedById Int?
  relatedId Int?               

  user          User               @relation("UserTransactions", fields: [userId], references: [id])
  createdBy     User               @relation("UserCreatedTransactions", fields: [createdById], references: [id])
  processedBy   User?              @relation("UserProcessedTransactions", fields: [processedById], references: [id])

  createdAt     DateTime           @default(now())
}

model Promotion {
  id            Int           @id @default(autoincrement())
  name          String
  description   String
  type          PromotionType
  startTime     DateTime
  endTime       DateTime
  minSpending   Float?
  rate          Float?
  points        Int?

  usedBy        User[]  @relation("UserPromotionsUsed")
  transactions  Transaction[] 

  createdAt     DateTime    @default(now())
}